<!DOCTYPE html>
<html>
<head>

<title>Shine</title>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="raphael.js"></script>
<script src="json.js"></script>
<style type="text/css">
body {
  width: 960px;
  margin: 0 auto;
}
.hidden {
  display: none;
}
h1, #nav {
  margin: 0;
  text-align: center;
}
input {
  width: 40px;
}
#toolbar {
  float: left;
  border: solid 1px black;
  height: 560px;
  width: 100px;
}
#toolbar p {
  margin: 0;
  font-size: .8em;
}
#rect_button span {
  display: inline-block;
  border: solid 1px black;
  height: 6px;
  width: 8px;
}
#newsave {
  border-right: solid 1px black;
  border-bottom: solid 1px black;
  padding: .5em;
}
#zoomslider {
  position: relative;
  top: 10px;
}
#user_canvas {
  float: left;
  border: solid 1px black;
  position: relative;
}
#user_canvas.spotlight svg * {
  opacity: .4;
}
#user_canvas_overlay {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  z-index: 1;
}
#shapes_list {
  float: left;
  border: solid 1px black;
  height: 480px;
  width: 200px;
  overflow-y: scroll;
}
#shapes_list p {
  margin: 0;
  cursor: pointer;
}
#shapes_list .current {
  background-color: mediumblue;
  color: white;
}
#shapes_list #list_shape_options {
  font-size: 80%;
  margin: 2pt;
}
#shapes_list input {
  width: 100px;
}
#user_canvas_controls {
  float: left;
  border: solid 1px black;
}
#timeslider {
  position: relative;
  top: 10px;
}
</style>

</head>
<body>

<h1>Shine</h1>

<p id="nav">
  <a href="/">Shine</a> |
  <a href="instructions">Instructions</a> |
  <a href="about">About</a> |
  <a href="news">News</a>
</p>

<div id="toolbar">
  <p><button id="rect_button"><span></span> Rect</button>
  <p class="hidden">Thickness
    <br>Corner Radius
    <br>Fill
  <p><button id="text_button">Text</button>
  <p class="hidden">Size
    <br>Font
	<p><button id="line_button">Line</button>
  <p><button id="move_button">Move</button>
  <p class="hidden">Choose a shape from the list
</div>

<p>
  <span id="newsave">
    <button>New</button>
    <button>Save</button>
    <button>Undo</button>
    <button>Redo</button>
  </span>
  <label for="width">Width:</label>
  <input type="text" id="width" value=640>
  <label for="height">Height:</label>
  <input type="text" id="height" value=480>
  <label for="zoom">Zoom:</label>
  <input type="text" id="zoom" value="100%" style="width:25px">
  <span id="zoomslider"></span>
</p>

<div id="user_canvas">
  <div id="user_canvas_overlay"></div>
</div>

<div id="shapes_list"></div>

<div id="user_canvas_controls">
  <button>&#9654;Play</button>
  <span id="timeslider"></span>
  <input type="text" id = "current_time" value="0.000s">/<input type="text" id = "duration" value="5.000s">
</div>

<button id="embed">Embed this in your Web page</button>

<script type="text/javascript">
var zoomslider = Raphael('zoomslider', 200, 30),
  zoombar = zoomslider.path('M 0 15 L 200 15'),
  zoom_overlay = zoomslider.rect(0, 0, 200, 30).attr({fill:'#000', opacity: 0}),
  zoomknob = zoomslider.rect(50, 5, 6, 20).attr({fill: '#000', stroke: 'none'});

var zoom = 100, zoom_startX;
function zoom_move(dx, dy){
  zoom = zoom_startX + dx + 50;
  zoom = zoom < 50 ? 50 : (zoom > 250 ? 250 : zoom);
  $('#zoom').val(zoom+'%');
  zoomknob.attr('x', zoom - 53);
} //zoom!
zoomknob.drag(zoom_move, function(){ //start
  zoom_startX = zoomknob.attr('x') + 3;
}); //zoom!!
zoom_overlay.drag(zoom_move, function(x, y, e){ //start
  zoom_startX = e.offsetX;
  zoom = zoom_startX + 50;
  $('#zoom').val(zoom+'%');
  zoomknob.attr('x', zoom_startX - 3);
}); //zoom!!!






var timeslider = Raphael('timeslider', 480, 30),
  timebar = timeslider.path('M 0 15, L 480 15'),
  time_overlay = timeslider.rect(0, 0, 480, 30).attr({fill:'#000', opacity: 0}),
  timeknob = timeslider.rect(-3, 5, 6, 20).attr({fill: '#000', stroke: 'none'});

var now = 0, time_startX, duration = 5000, change = 0;
function time_move(dx, dy){
  now = Math.round((time_startX+dx)*duration/480);
  now = now < 0 ? 0 : (now > duration ? duration : now);
  $('#current_time').val((now/1000).toFixed(3)+'s');
  timeknob.attr('x', Math.round(now*480/duration) - 3);
  shapes_list.children().each(interpolate_anim_state);
}
timeknob.drag(time_move, function(){ //start
  time_startX = timeknob.attr('x') + 3;
});
time_overlay.drag(time_move, function(x, y, e){ //start
  time_startX = e.offsetX;
  now = Math.round(time_startX*duration/480);
  $('#current_time').val((now/1000).toFixed(3)+'s');
  timeknob.attr('x', time_startX - 3);
  shapes_list.children().each(interpolate_anim_state);
});

Raphael.easing_formulas.time_easing = function(n){
  if (now === 0)
    change = now;
  now = n * duration / 1000;
  if (now-change > .12){
    change = now;
    $('#current_time').val(now.toFixed(3)+'s');
  }
  return n
}

//Play button
$('#user_canvas_controls button').click(function(){
  now = 0;
  timeknob.attr('x', -3);
  $('current_time').val(0.000 + 's')
  shapes_list.children().each(interpolate_anim_state);
  shapes_list.children().each(function(){
    var raphael_this = $(this).data('raphael'), history = $(this).data('history');
    for(var attr in history)
      (function(attr){
        (function(){
          now = Math.round((timeknob.attr('x') + 3)*duration/480);
          var new_attr = {};
          for(var next in history[attr])
            if(next > now)
              break;
            else
              next = duration + 1;
          next = +next;
          new_attr[attr] = history[attr][next];
          if(next > duration)
            now = duration;
          else
            raphael_this.animate(new_attr, next - now, arguments.callee);
        }());
      }(attr));
  });
  timeknob.animate({'x': 477}, duration, "time_easing", function(){
    now = 5000;
    $('#current_time').val((now/1000).toFixed(3)+'s');
  });
});

function interpolate_anim_state(){
  var raphael_this = $(this).data('raphael'), history = $(this).data('history');
  if(raphael_this === undefined)
    return;
  //animation state now
  for(var attr in history){
    var past = 0, future = duration + 1;
    for(var time in history[attr])
      if(time <= now && time > past)
        past = +time;
    for(var time in history[attr])
      if(time >= now && time < future)
        future = +time;
    if(future === past || future > duration)
      raphael_this.attr(attr, history[attr][past]);
    else
      raphael_this.attr(attr, history[attr][past] +
        (history[attr][future] - history[attr][past])*(now - past)/(future - past)); //replace with proper easing
  }
}


//list of raphael shapes and sets
var shapes_list_click = $.noop, //canonical 'current' click handler on shapes_list
    //(set by e.g. Move button, then reset by click handler for all toolbars)
  shapes_list = $('#shapes_list').click(function(e){
    if(e.target !== this)
      return shapes_list_click.apply(this, arguments);
    current_list_shape.removeClass('current');
    current_list_shape = $();
    list_shape_options.detach();
    shapes_list_click.apply(this, arguments);
  });

//shape in list, options thereof
var current_list_shape = $(), list_shape_options = $('<p id="list_shape_options"></p>'),
  //rename
  rename = $('<p>Name: <input type="text" name="rename" id="rename_option"></p>')
    .appendTo(list_shape_options).find('input').bind('keydown keypress', (function(){
      function update_name(){
        list_shape_options.prev().html(rename.val() || '&nbsp;');
      }
      return function(){
        setTimeout(update_name, 0);
      };
    }())),
  //remove
  remove = $('<button>Remove</button>').click(function(){
    var shape = list_shape_options.prev();
    shape.data('raphael').remove();
    shape.remove();
    list_shape_options.detach();
    current_list_shape = $();
  }).appendTo(list_shape_options);

//click handler attached to each list item in list of shapes
function list_shape_click(){
  (current_list_shape.removeClass('current').data('remove list options') || $.noop)();
  current_list_shape = $(this).addClass('current');

  var current_raphael_shape = current_list_shape.data('raphael');

  rename.val(this.innerHTML === '&nbsp;' ? '' : this.innerHTML);
  x_pos.val(current_raphael_shape.attr('x'));
  y_pos.val(current_raphael_shape.attr('y'));

  current_list_shape.data('add list options')(current_raphael_shape);

  list_shape_options.insertAfter(this);
}
//x
var x_pos = $('<form><label for="x_pos_option"><i>x</i>: </label><input type="text" name="x_pos" id="x_pos_option">'),
    x_input = x_pos.submit(function(){
      current_list_shape.data('raphael').attr('x', this.x_pos.value);
      return false;
    }).appendTo(list_shape_options).find('input'),
//y
    y_pos = $('<form><label for="y_pos_option"><i>y</i>: </label><input type="text" name="y_pos" id="y_pos_option">'),
    y_input = y_pos.submit(function(){
      current_list_shape.data('raphael').attr('y', this.y_pos.value);
      return false;
    }).appendTo(list_shape_options).find('input');

function add_xy(){
  x_pos.insertBefore(remove);
  y_pos.insertBefore(remove);
}
function rm_xy(){
  x_pos.detach();
  y_pos.detach();
}
//additional options to be added on a per-shape basis:
//fill
var fill = $('<p><label for="fill">Fill</label><input type="checkbox" id="fill" name="fill" style="width:auto"></p>'),
  fill_checkbox = fill.find('input').change(function(){
    current_list_shape.data('raphael').attr('fill-opacity', +this.checked);
  });
function add_fill(raphael_shape){
  fill_checkbox[0].checked = raphael_shape.attr('fill-opacity') === 1;
  fill.insertBefore(remove);
}
function rm_fill(){
  fill.detach();
}

//endpoint for lines (including curves - don't move into lines)
var end_point = $('<form><label for="endpoint_x_field">Point 2 X</label><input type="text" id="endpoint_x_field" name="endpoint_x_field">'+
    '<label for="endpoint_y_field">Point 2 Y</label><input type="text" id="endpoint_y_field" name="endpoint_y_field"></form>')
    end_point_submit = end_point.find('form').submit(function(){
      current_list_shape.data('raphael').attr('path');
      return false;
    }).appendTo(list_shape_options).find('input');

function add_linepoints(raphael_shape){
  end_point.insertBefore(remove);
}
function rm_linepoints(){
  end_point.detach();
}

//the Raphael canvas on which all the shapes are drawn
var user_canvas = Raphael('user_canvas', 640, 480);
user_canvas.text(200,150,'hello world').attr('font-size',40);

//highlight a Raphael shape in the user_canvas
var spotlight = (function(){
  var spotlit_shape, user_canvas_div = $('#user_canvas');
  function spotlight(shape){
    user_canvas_div.addClass('spotlight');
    spotlit_shape = shape.attr('opacity', .8);
  }
  function off(){
    user_canvas_div.removeClass('spotlight');
    spotlit_shape.attr('opacity', '');
  }
  spotlight.off = off;
  return spotlight;
}());



//catches all the mouse events over the user_canvas
var overlay = $('#user_canvas_overlay');

//drag-and-drop subroutine
//USAGE: drag([event Object], [mousemove handler function(dx, dy){...}]);
var drag = (function(){
  var doc = $(document), initialX, initialY, onmove, onup;
  function mousemove(e){
    onmove(e.clientX - initialX, e.clientY - initialY);
    return false;
  }
  function mouseup(){
    spotlight.off();
    doc.unbind('mousemove mouseup');
    onup();
    return false;
  }
  function drag(e, move, up){
    initialX = e.clientX;
    initialY = e.clientY;
    onmove = move;
    onup = up;
    doc.mousemove(mousemove).mouseup(mouseup);
  }
  return drag;
}());



//canonical 'current' click handler on all shapes in the user canvas
//(set by e.g. Move button, then reset by click handler for all toolbars)
var raphael_shape_click = $.noop;
//calls the canonical 'current' click handler,
//attached to all shapes on creation (e.g. rect)
function call_raphael_shape_click(){
  raphael_shape_click.apply(this, arguments);
}



//show/hide toolbar button options
var current_button_description = $();
$('#toolbar button').click(function(){
  // current_button_description.hide();
  // current_button_description = $(this).parent().next().show();

  //make sure overlay not hidden, reset event handlers
  overlay.unbind().show();
  shapes_list_click = $.noop;
  raphael_shape_click = $.noop;
});


/****
So at this point, checklist for creating user shapes:
user_canvas.<Raphael API call>.attr(<more Raphael API>)
  .mousedown(call_raphael_shape_click); //bound to every user_canvas shape
//next, item in shapes list
$('<some html>').data('raphael', <previously_created_Raphael_shape_in_user_canvas>)
  .data('add list options', function(){
    //when this list item is clicked, add options
  }).data('remove list options', function(){
    //when another list item is clicked, remove options
  }).click(list_shape_click) //bound to every list item
  .appendTo(shapes_list);
$(<previously_created_Raphael_shape_in_user_canvas>.node)
  .data('shapes list', <previously_created_shapes_list_item_jQ>);
//and most likely spotlight the shape in user_canvas
spotlight(<previously_created_Raphael_shape_in_user_canvas>);
****/


//rectangle tool
var rect_count = 0;
$('#rect_button').click(function(){
  overlay.mousedown(function(e){
    rect_count += 1;
    var cornerX = e.offsetX, cornerY = e.offsetY, history = {},
      rect = user_canvas.rect(cornerX, cornerY, 0, 0).attr('fill', 'transparent')
        .mousedown(call_raphael_shape_click),
      list_rect_jQ = $('<p>Rectangle '+rect_count+'</p>').data('raphael', rect)
        .data('history', history)
        .data('add list options', function(raphael_shape){
          add_xy();
          add_fill(raphael_shape);
          //add_width(raphael_shape);
          //add_height(raphael_shape);
        })
        .data('remove list options', function(){
          rm_xy();
          rm_fill();
          //rm_width();
          //rm_height();
        })
        .click(list_shape_click)
        .hover(function(){
          spotlight(rect);
        }, function(){
          spotlight.off();
        })
        .appendTo(shapes_list);
    $(rect.node).data('shapes list', list_rect_jQ);

    spotlight(rect);

    drag(e, function(dx, dy){
      if(dx < 0)
        rect.attr({
          width: -dx,
          x: cornerX + dx
        });
      else
        rect.attr({
          width: dx,
          x: cornerX
        });
      if(dy < 0)
        rect.attr({
          height: -dy,
          y: cornerY + dy
        });
      else
        rect.attr({
          height: dy,
          y: cornerY
        });
    }, function(){
      $.each(['x', 'y', 'width', 'height'], function(i, attr){
        history[attr] = [];
        history[attr][0] = rect.attr(attr);
      });
    });

    return false;
  });
});

var text_count = 0;
$('#text_button').click(function(){
  overlay.click(function(e){
    text_count += 1;
    var text = user_canvas.text(e.offsetX, e.offsetY, 'text').attr('font-size',24), 
      history = {},
      text_option = $('<p id="text_option_p"><label for="text_option">Text:</label><input type="text" id="text_option" name="text_option" style="width:auto"></p>'),
      text_opt_input = text_option.find('input').bind('keydown keypress', (function(){
          function update_text(){
            $(text.node).children().text(text_opt_input.val());
          }
          return function(){
            setTimeout(update_text, 0);
          };
        }())),
      list_text_jQ = $('<p>Text ' + text_count + '</p>').data('raphael', text)
        .data('history', history)
        .data('add list options', function(){
          add_xy();
          text_opt_input.val($(text.node).children().text());
          text_option.insertBefore(remove);
        })
        .data('remove list options', function(){
          rm_xy();
          text_option.detach();
        })
        .click(list_shape_click)
        .hover(function(){
          spotlight(rect);
        }, function(){
          spotlight.off();
        })
        .appendTo(shapes_list);
    $(text.node).data('shapes list', list_text_jQ);
    $.each(['x', 'y'], function(i, attr){
      history[attr] = [];
      history[attr][0] = text.attr(attr);
    });
  });
});

var line_count = 0;
$('#line_button').click(function(){
  overlay.mousedown(function(e){
    line_count += 1;
    var cornerX = e.offsetX, cornerY = e.offsetY, history = {},
      line = user_canvas.path('M'+cornerX+' '+cornerY+'L'+cornerX +' '+cornerY)
        .mousedown(call_raphael_shape_click),
      list_line_jQ = $('<p>Line '+line_count+'</p>').data('raphael', line)
        .data('history', history)
        .data('add list options', function(raphael_shape){
          add_linepoints(raphael_shape);
        })
        .data('remove list options', function(){
          rm_linepoints();
        })
        .click(list_shape_click).appendTo(shapes_list);
    $(line.node).data('shapes list', list_line_jQ);

    spotlight(line);

    drag(e, function(dx, dy){
        line.attr({
          path: 'M'+cornerX+' '+cornerY+'l'+dx+' '+dy
        });
    }, function(){
      $.each(['line'], function(i, attr){
        history[attr] = [];
        history[attr][0] = line.attr(attr);
      });
    });
    return false;
  });
});
//move tool
$('#move_button').click(function(){
  shapes_list_click = shapes_list_click_when_moving;
  raphael_shape_click = raphael_shape_click_when_moving;
  if(!current_list_shape.length)
    overlay.hide();
  else{
    if(current_list_shape.data('raphael').attr('x'))
  		overlay.mousedown(shape_drag);
  	else
  		alert('tried to move');
  }
});
function shapes_list_click_when_moving(e){
  if(e.target === this)
    overlay.hide();
  else
    overlay.show();
}
function raphael_shape_click_when_moving(e){
  $(this.node).data('shapes list').click();
	if(this.attr('x'))
  	shape_drag(e);
	else
		alert("tried to move");
}

function shape_drag(e){
  var current_raphael_shape = current_list_shape.data('raphael'),
    startX = +current_raphael_shape.attr('x'),
    startY = +current_raphael_shape.attr('y');
  spotlight(current_raphael_shape);
  drag(e, function(dx, dy){
    current_raphael_shape.attr({
      x: startX + dx,
      y: startY + dy
    });
    x_pos.val(current_raphael_shape.attr('x'));
    y_pos.val(current_raphael_shape.attr('y'));
  }, function(){
      $.each(['x', 'y'], function(i, attr){
        current_list_shape.data('history')[attr][now] = current_raphael_shape.attr(attr);
      });
  });
}




$('button#embed').click(function(){
  $.get('raphael.js', function(raphael_js){
    $('<textarea></textarea>').val(
      '<div id="user_canvas"></div>\n' +
      '<div id="user_canvas_controls"><button>&#9654;Play</button><span id="timeslider"></span></div>\n' +
      '<div id="shapes_list" style="display:none">\n' +
      shapes_list.html() +
      '</div>\n' +
      '<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></scr'+'ipt>\n' +
      '<script type="text/javascript">\n' +
      raphael_js+'\n' +
      '</scr'+'ipt>\n' +
      '<script type="text/javascript">\n' +
      $('script:eq(2)').html().replace(/^.*zoom.*$/mg, '//$&') +
      (function(){
        var str = '';
        shapes_list.children().each(function(i){
          var raphael_this = $(this).data('raphael'), history = $(this).data('history');
          if(!raphael_this)
            return;
          str += 'var shape = user_canvas.' + raphael_this.type + '(';
          for(var attr in history)
            str += history[attr][0];
          str += '), history = '+JSON.stringify(history)+';\n';
          str += 'for(var attr in history)\n';
          str += '  for(var i in history[attr])\n';
          str += '    if(history[attr][i] === null)\n';
          str += '      delete history[attr][i];\n';
          str += 'shapes_list.children(":eq('+i+')").data("raphael", shape)';
          str += '.data("history", history);';
        });
        return str;
      }()) +
      '</scr'+'ipt>'
    ).appendTo('body');
  });
});


</script>

</body>
</html>
