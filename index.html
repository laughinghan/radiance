<!DOCTYPE html>
<html>
<head>

<title>Shine</title>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="raphael.js"></script>

<style type="text/css">
body {
  max-width: 960px;
  margin: 0 auto;
}
.hidden {
  display: none;
}
h1, #nav {
  margin: 0;
  text-align: center;
}
input {
  width: 25px;
}
#toolbar {
  float: left;
  border: solid 1px black;
  height: 560px;
  width: 100px;
}
#toolbar p {
  margin: 0;
  font-size: .8em;
}
#rect_button span {
  display: inline-block;
  border: solid 1px black;
  height: 6px;
  width: 8px;
}
#newsave {
  border-right: solid 1px black;
  border-bottom: solid 1px black;
  padding: .5em;
}
#zoomslider {
  position: relative;
  top: 10px;
}
#user_canvas {
  float: left;
  border: solid 1px black;
  position: relative;
}
#user_canvas.spotlight svg * {
  opacity: .4;
}
#user_canvas_overlay {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  z-index: 1;
}
#shapes_list {
  float: left;
  border: solid 1px black;
  height: 480px;
  width: 200px;
  overflow-y: scroll;
}
#shapes_list p {
  margin: 0;
  cursor: pointer;
}
#shapes_list .current {
  background-color: mediumblue;
  color: white;
}
#shapes_list .list_shape_options {
  font-size: .7em;
}
#shapes_list input {
  width: 100px;
}
#user_canvas_controls {
  float: left;
  border: solid 1px black;
}
#timeslider {
  position: relative;
  top: 10px;
}
</style>

</head>
<body>

<h1>Shine</h1>

<p id="nav">
  <a href="/">Shine</a> |
  <a href="instructions">Instructions</a> |
  <a href="about">About</a> |
  <a href="news">News</a>
</p>

<div id="toolbar">
  <p><button id="rect_button"><span></span> Rect</button>
  <p class="hidden">Thickness
    <br>Corner Radius
    <br>Fill
  <p><button id="text_button">Text</button>
  <p class="hidden">Size
    <br>Font
  <p><button id="move_button">Move</button>
  <p class="hidden">Choose a shape from the list
</div>

<p>
  <span id="newsave">
    <button>New</button>
    <button>Save</button>
  </span>
  <label for="width">Width:</label>
  <input type="text" id="width" value=640>
  <label for="height">Height:</label>
  <input type="text" id="height" value=480>
  <label for="zoom">Zoom:</label>
  <input type="text" id="zoom" value="100%" style="width:25px">
  <span id="zoomslider"></span>
</p>

<div id="user_canvas">
  <div id="user_canvas_overlay"></div>
</div>

<div id="shapes_list"></div>

<div id="user_canvas_controls">
  <button>&#9654;Play</button>
  <span id="timeslider"></span>
  <input type="text" id = "current_time" value="0.0s">/<input type="text" id = "duration" value="5.0s">
</div>

<script type="text/javascript">
var zoomslider = Raphael('zoomslider', 200, 30),
  zoombar = zoomslider.path('M 0 15 L 200 15'),
  zoom_overlay = zoomslider.rect(0, 0, 200, 30).attr({fill:'#000', opacity: 0}),
  zoomknob = zoomslider.rect(50, 5, 6, 20).attr({fill: '#000', stroke: 'none'});

var zoom = 100, zoom_startX;
function zoom_move(dx, dy){
  zoom = zoom_startX + dx + 50;
  zoom = zoom < 50 ? 50 : (zoom > 250 ? 250 : zoom);
  $('#zoom').val(zoom+'%');
  zoomknob.attr('x', zoom - 53);
}
zoomknob.drag(zoom_move, function(){ //start
  zoom_startX = zoomknob.attr('x') + 3;
});
zoom_overlay.drag(zoom_move, function(x, y, e){ //start
  zoom_startX = e.offsetX;
  zoom = zoom_startX + 50;
  $('#zoom').val(zoom+'%');
  zoomknob.attr('x', zoom_startX - 3);
});






var timeslider = Raphael('timeslider', 480, 30),
  timebar = timeslider.path('M 0 15, L 480 15'),
  time_overlay = timeslider.rect(0, 0, 480, 30).attr({fill:'#000', opacity: 0}),
  timeknob = timeslider.rect(-3, 5, 6, 20).attr({fill: '#000', stroke: 'none'});

var time = 0, start_time, duration = 5000;
function time_move(dx, dy){
  time = Math.round((start_time+dx)*duration/480);
  time = time < 0 ? 0 : (time > duration ? duration : time);
  $('#current_time').val((time/1000).toFixed(1)+'s');
  timeknob.attr('x', Math.round(time*480/duration) - 3);
}
timeknob.drag(time_move, function(){ //start
  start_time = timeknob.attr('x') + 3;
});
time_overlay.drag(time_move, function(x, y, e){ //start
  start_time = e.offsetX;
  time = Math.round(start_time*duration/480);
  $('#current_time').val((time/1000).toFixed(1)+'s');
  timeknob.attr('x', start_time - 3);
});








var user_canvas = Raphael('user_canvas', 640, 480);
user_canvas.text(200,150,'hello world').attr('font-size',40);



//list of raphael shapes and sets
var shapes_list_click = $.noop, //canonical 'current' click handler on shapes_list
    //(set by e.g. Move button, then reset by click handler for all toolbars)
  shapes_list = $('#shapes_list').click(function(e){
    if(e.target !== this)
      return shapes_list_click.apply(this, arguments);
    current_list_shape.removeClass('current');
    list_shape_options.detach();
    current_list_shape = $();
    shapes_list_click.apply(this, arguments);
  });

//shape in list, options thereof
var current_list_shape = $(), list_shape_options = $('<p class="list_shape_options"></p>'),
  //rename
  rename = $('<form>Rename: <input type="text" name="rename" id="rename_option"></form>').submit(function(){
    list_shape_options.prev().html(this.rename.value);
    return false;
  }).appendTo(list_shape_options).find('#rename_option'),
  //fill
  fill = $('<input type="checkbox" id="fill" name="fill" style="width:auto"><label for="fill">fill</label>').change(function(){
    current_list_shape.data('raphael').attr('fill-opacity', +this.checked);
  }).appendTo(list_shape_options),
  //x
  x_pos = $('<form>X: <input type="text" name="x_pos" id="x_pos_option">').submit(function(){
    current_list_shape.data('raphael').attr('x', this.x_pos.value);
    return false;
  }).appendTo(list_shape_options).find('#x_pos_option'),
  //y
  y_pos = $('<form>Y: <input type="text" name="y_pos" id="y_pos_option">').submit(function(){
    current_list_shape.data('raphael').attr('y', this.y_pos.value);
    return false;
  }).appendTo(list_shape_options).find('#y_pos_option');
//remove
$('<button>Remove</button>').click(function(){
  var shape = list_shape_options.prev();
  shape.data('raphael').remove();
  shape.remove();
  list_shape_options.detach();
  current_list_shape = $();
}).appendTo(list_shape_options);

//click handler attached to each list item in list of shapes
function list_shape_click(){
  current_list_shape.removeClass('current');
  current_list_shape = $(this).addClass('current');

  var current_raphael_shape = current_list_shape.data('raphael');

  rename.val(this.innerHTML);
  fill[0].checked = current_raphael_shape.attr('fill-opacity') === 1;
  x_pos.val(current_raphael_shape.attr('x'));
  y_pos.val(current_raphael_shape.attr('y'));

  list_shape_options.insertAfter(this);
}



//canonical 'current' click handler on all shapes in the user canvas
//(set by e.g. Move button, then reset by click handler for all toolbars)
var raphael_shape_click = $.noop;
//calls the canonical 'current' click handler,
//attached to all shapes on creation (e.g. rect)
function call_raphael_shape_click(){
  raphael_shape_click.apply(this, arguments);
}



//catches all the mouse events over the user_canvas
var overlay = $('#user_canvas_overlay');



//highlight a Raphael shape in the user_canvas
var spotlight = (function(){
  var spotlit_shape, user_canvas_div = $('#user_canvas');
  function spotlight(shape){
    user_canvas_div.addClass('spotlight');
    spotlit_shape = shape.attr('opacity', .8);
  }
  function off(){
    user_canvas_div.removeClass('spotlight');
    spotlit_shape.attr('opacity', '');
  }
  spotlight.off = off;
  return spotlight;
}());



//show/hide toolbar button options
var current_button_description = $();
$('#toolbar button').click(function(){
  current_button_description.hide();
  current_button_description = $(this).parent().next().show();

  //make sure overlay not hidden, reset event handlers
  overlay.unbind().show();
  shapes_list_click = $.noop;
  raphael_shape_click = $.noop;
});

//rectangle tool
var rect_count = 0;
$('#rect_button').click(function(){
  overlay.mousedown(function(e){
    rect_count += 1;
    var startX = e.offsetX, startY = e.offsetY,
      rect = user_canvas.rect(startX, startY, 0, 0).attr('fill', 'transparent')
        .mousedown(call_raphael_shape_click),
      list_rect_jQ = $('<p>Rectangle '+rect_count+'</p>').data('raphael', rect)
        .click(list_shape_click).appendTo(shapes_list);
    $(rect.node).data('shapes list', list_rect_jQ);

    spotlight(rect);

    overlay.mousemove(function(e){
      var x = e.offsetX, y = e.offsetY;
      rect.attr({
        x: x > startX ? startX : x,
        y: y > startY ? startY : y,
        width: x > startX ? x - startX : startX - x,
        height: y > startY ? y - startY : startY - y
      });
    }).bind('mouseup mouseleave', function(){
      spotlight.off();
      overlay.unbind('mousemove mouseup mouseleave');
    }).mouseleave(function(){
      list_rect_jQ.remove();
      rect.remove();
      rect_count -= 1;
    });
  });
});

var text_count = 0;
$('#text_button').click(function(){
  overlay.click(function(e){
    text_count += 1;
    var text = paper.text(e.offsetX, e.offsetY, '');
    // (function(){
    //   var empty = true;
    //   function onfocus()
    //   {
    //     if(empty)
    //     {
    //       this.value = '';
    //       this.style.color = 'black';
    //       this.onkeydown();
    //     }
    //   }
    //   function onblur()
    //   {
    //     empty = this.value === '';
    //     if(empty)
    //     {
    //       this.value = 'math';
    //       this.style.color = 'gray';
    //       this.onkeydown();
    //     }
    //   }
    //   var updateLink = (function(){
    //     var link = document.getElementById('link'), text = document.getElementsByTagName('input')[0];
    //     return function()
    //     {
    //       link.href = '/chat/' + text.value;
    //       link.innerHTML = 'http://lolgebra.com/chat/' + text.value;
    //     };
    //   }());
    //   function onkeydown()
    //   {
    //     setTimeout(updateLink,0);
    //   }
    //   (function(){
    //     var textbox = document.getElementsByTagName('input')[0];
    //     textbox.onfocus = onfocus;
    //     textbox.onblur = onblur;
    //     textbox.onkeypress = textbox.onkeydown = onkeydown;
    //   }());
    // }());
  })
})

//move tool
$('#move_button').click(function(){
  shapes_list_click = shapes_list_click_when_moving;
  raphael_shape_click = raphael_shape_click_when_moving;
  overlay.mousedown(rect_drag);

  if(!current_list_shape.length)
    overlay.hide();
});
function shapes_list_click_when_moving(e){
  if(e.target === this)
    overlay.hide();
  else
    overlay.show();
}
function raphael_shape_click_when_moving(e){
  $(this.node).data('shapes list').click();
  rect_drag(e);
}

function rect_drag(e){
  var current_raphael_shape = current_list_shape.data('raphael'),
    startMouseX = e.offsetX, startMouseY = e.offsetY,
    startRaphaelX = current_raphael_shape.attr('x'),
    startRaphaelY = current_raphael_shape.attr('y');
  spotlight(current_raphael_shape);
  overlay.mousemove(function(e){
    current_raphael_shape.attr({
      x: startRaphaelX + e.offsetX - startMouseX,
      y: startRaphaelY + e.offsetY - startMouseY
    });
    x_pos.val(current_raphael_shape.attr('x'));
    y_pos.val(current_raphael_shape.attr('y'));
  }).bind('mouseup mouseleave', function(){
    spotlight.off();
    overlay.unbind('mousemove mouseup mouseleave');
  });
}


</script>

</body>
</html>
